{% extends 'base.html' %}
{% load url_extras %}

{% block title %}Create Chore{% endblock %}

{% block content %}
<div class="py-10">
    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        <div class="p-6 md:p-10">
            <div class="flex items-center justify-between flex-col md:flex-row gap-3 mb-6">
                <div>
                    <p class="text-sm uppercase text-primary tracking-widest font-semibold">Chore Builder</p>
                    <h1 class="text-3xl font-bold text-gray-900">
                        {% if edit_mode %}Edit chore{% else %}Create a new chore{% endif %}
                    </h1>
                    <p class="text-gray-600 mt-1">Admins/owners can create chores. Global chores can be claimed by anyone.</p>
                </div>
                <a href="{% url 'home' %}?household={{ selected_household.id }}"
                    class="text-primary font-semibold hover:underline">Back to dashboard</a>
            </div>

            {% if form.errors %}
            <div class="mb-4">
                {% include 'components/alert.html' with variant="error" message="Please fix the errors below." %}
            </div>
            {% endif %}

            <form method="post" class="space-y-8">
                {% csrf_token %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include 'components/form_field.html' with label="Title" field=form.title errors=form.title.errors required=True for_id=form.title.id_for_label %}
                    {% include 'components/form_field.html' with label="Household" field=form.household errors=form.household.errors required=True for_id=form.household.id_for_label %}
                </div>

                {% include 'components/form_field.html' with label="Description" field=form.description errors=form.description.errors for_id=form.description.id_for_label %}

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% include 'components/form_field.html' with label="Assignment Type" field=form.assignment_type errors=form.assignment_type.errors required=True for_id=form.assignment_type.id_for_label help_text="Assigned = choose user. Global = anyone can claim." %}
                    <div id="assignee-wrapper" data-disable-wrapper="assignee" data-fv-show="id_assignment_type=assigned">
                        {% include 'components/form_field.html' with label="Assignee (for assigned)" field=form.assigned_to errors=form.assigned_to.errors for_id=form.assigned_to.id_for_label %}
                    </div>
                    <div id="rotation-wrapper" data-disable-wrapper="rotation" data-fv-show="id_assignment_type=rotating">
                        {% include 'components/form_field.html' with label="Rotation users (for rotating)" field=form.rotation_users errors=form.rotation_users.errors for_id=form.rotation_users.id_for_label help_text="Defaults to everyone; pick who participates in the rotation." %}
                    </div>
                    {% include 'components/form_field.html' with label="Priority" field=form.priority errors=form.priority.errors for_id=form.priority.id_for_label %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% include 'components/form_field.html' with label="Points" field=form.base_points errors=form.base_points.errors required=True for_id=form.base_points.id_for_label %}
                    {% include 'components/form_field.html' with label="Difficulty" field=form.difficulty errors=form.difficulty.errors required=True for_id=form.difficulty.id_for_label %}
                    <div>
                        <div data-disable-wrapper="due-date" data-fv-disable="id_anytime">
                            {% include 'components/form_field.html' with label="Due date (optional)" field=form.due_date errors=form.due_date.errors for_id=form.due_date.id_for_label %}
                        </div>
                        <label class="inline-flex items-center space-x-2 mt-2">
                            {{ form.anytime }}
                            <span class="text-sm text-gray-700">Anytime (no due date / no recurrence)</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-200 rounded-xl p-4" id="recurrence-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">Recurrence</h3>
                            <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                                <label class="inline-flex items-center space-x-2">
                                    {{ form.anytime }}
                                    <span class="text-sm text-gray-700">Anytime</span>
                                </label>
                                <label class="inline-flex items-center space-x-2">
                                    {{ form.is_recurring }}
                                    <span class="text-sm text-gray-700">Recurring?</span>
                                </label>
                            </div>
                        </div>

                        <p class="text-xs text-gray-600 mb-2">Recurring timers start after you complete the chore; overdue chores shift forward based on when you finish.</p>

                        <div class="space-y-3" id="recurrence-fields" data-fv-show="id_is_recurring" data-disable-wrapper="recurrence">
                            {% include 'components/form_field.html' with label="Frequency" field=form.frequency errors=form.frequency.errors for_id=form.frequency.id_for_label %}

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
                                {% include 'components/form_field.html' with label="Repeat every" field=form.interval_value errors=form.interval_value.errors for_id=form.interval_value.id_for_label %}
                                <div>
                                    <p class="text-sm text-gray-700 mb-1">Interval unit</p>
                                    <p id="interval-unit-label" class="text-sm font-semibold text-gray-900">weeks</p>
                                    <p class="text-xs text-gray-500">Changes with frequency (days/weeks/months).</p>
                                </div>
                            </div>

                            <div id="monthly-fields" class="space-y-2" data-disable-wrapper="monthly" data-fv-show="id_frequency=monthly">
                                <p class="text-sm font-semibold text-gray-800">Monthly options</p>
                                <p class="text-xs text-gray-600">Select a day/weekday pattern or leave these blank to repeat monthly from the last completion date.</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {% include 'components/form_field.html' with label="Mode" label_hint="(day, weekday, or completion-based)" field=form.monthly_mode errors=form.monthly_mode.errors for_id=form.monthly_mode.id_for_label wrapper_classes="text-sm" %}
                                    <div id="monthly-day-wrapper" data-disable-wrapper="monthly-day" data-fv-show="id_monthly_mode=day">
                                        {% include 'components/form_field.html' with label="Day of month" field=form.day_of_month errors=form.day_of_month.errors for_id=form.day_of_month.id_for_label wrapper_classes="text-sm" %}
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="monthly-weekday-wrapper" data-disable-wrapper="monthly-weekday" data-fv-show="id_monthly_mode=weekday">
                                    {% include 'components/form_field.html' with label="Week of month" field=form.week_of_month errors=form.week_of_month.errors for_id=form.week_of_month.id_for_label wrapper_classes="text-sm" %}
                                    {% include 'components/form_field.html' with label="Weekday" field=form.weekday_of_month errors=form.weekday_of_month.errors for_id=form.weekday_of_month.id_for_label wrapper_classes="text-sm" %}
                                </div>
                            </div>

                            <div id="weekly-fields" data-disable-wrapper="weekly">
                                {% include 'components/form_field.html' with label="Active days of week (optional)" field=form.days_of_week errors=form.days_of_week.errors for_id=form.days_of_week.id_for_label help_text="Applies to any frequency; leave empty for all days." %}
                            </div>

                            {% include 'components/form_field.html' with label="Active months (optional)" field=form.months_of_year errors=form.months_of_year.errors for_id=form.months_of_year.id_for_label help_text="Limit to certain months (e.g., summer tasks)." %}

                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Summary</p>
                                <p id="recurrence-summary" class="text-sm text-gray-800">Repeats based on the settings above.</p>
                            </div>
                        </div>
                    </div>

                    <div class="border border-gray-200 rounded-xl p-4 space-y-3">
                        <h3 class="text-lg font-semibold text-gray-900">Verification</h3>
                        <label class="inline-flex items-center space-x-2">
                            {{ form.requires_verification }}
                            <span class="text-sm text-gray-800">Requires verification</span>
                        </label>
                        <label class="inline-flex items-center space-x-2">
                            {{ form.verification_photo_required }}
                            <span class="text-sm text-gray-800">Photo required</span>
                        </label>
                        <p class="text-xs text-gray-500">Admins/owners can approve completed chores when verification is on.</p>
                    </div>
                </div>

                <div class="flex justify-end gap-3 items-center flex-wrap">
                    {% url_with 'home' household=selected_household.id as cancel_href %}
                    {% include 'components/button.html' with href=cancel_href label="Cancel" variant="secondary" size="md" %}
                    {% include 'components/button.html' with type="submit" label=edit_mode|yesno:"Update chore,Create chore" variant="primary" size="lg" %}
                    <div class="flex items-center text-sm text-gray-500">
                        <span class="mr-2">Effort/points preview:</span>
                        <span id="points-preview" class="font-semibold text-gray-800">{{ form.base_points.value|default:form.base_points.initial|default:10 }} pts · {{ form.difficulty.value|default:form.difficulty.initial|default:"medium" }}</span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const $ = id => document.getElementById(id);
    const anytime = $('id_anytime'), isRecurring = $('id_is_recurring');
    const frequency = $('id_frequency'), intervalValue = $('id_interval_value');
    const monthlyMode = $('id_monthly_mode'), dayOfMonth = $('id_day_of_month');
    const weekOfMonth = $('id_week_of_month'), weekdayOfMonth = $('id_weekday_of_month');
    const daysOfWeek = $('id_days_of_week'), months = $('id_months_of_year');
    const summaryEl = $('recurrence-summary'), intervalLabel = $('interval-unit-label');
    const pointsInput = $('id_base_points'), difficultyInput = $('id_difficulty');
    const pointsPreview = $('points-preview');

    // Mutual exclusion: anytime and recurring checkboxes
    anytime?.addEventListener('change', () => { if (anytime.checked && isRecurring) { isRecurring.checked = false; isRecurring.dispatchEvent(new Event('change')); } updateDynamic(); });
    isRecurring?.addEventListener('change', () => { if (isRecurring.checked && anytime) { anytime.checked = false; anytime.dispatchEvent(new Event('change')); } updateDynamic(); });

    function updateDynamic() {
        // Interval unit label
        if (intervalLabel && frequency) {
            const unit = {daily: 'days', weekly: 'weeks', monthly: 'months'}[frequency.value] || 'weeks';
            intervalLabel.textContent = unit;
        }
        // Summary text
        if (summaryEl) summaryEl.textContent = buildSummary();
        // Points preview
        if (pointsPreview) {
            const pts = pointsInput?.value || '';
            const diff = difficultyInput?.selectedOptions?.[0]?.textContent.trim() || 'Medium';
            pointsPreview.textContent = `${pts || '—'} pts · ${diff}`;
        }
    }

    function buildSummary() {
        if (anytime?.checked) return "Anytime chore (no due date / recurrence).";
        if (!isRecurring?.checked) return "One-time chore (no recurrence).";
        const freq = frequency?.value || 'weekly';
        const interval = intervalValue?.value || '1';
        const unit = freq === 'daily' ? 'day' : freq === 'weekly' ? 'week' : 'month';
        let parts = [`Every ${interval} ${unit}${parseInt(interval) > 1 ? 's' : ''}`];
        const days = Array.from(daysOfWeek?.selectedOptions || []).map(o => o.textContent.trim());
        if (days.length) parts.push(`on ${days.join(', ')}`);
        if (freq === 'monthly') {
            const mode = monthlyMode?.value || 'day';
            if (mode === 'from_completion' || (!dayOfMonth?.value && !(weekOfMonth?.value && weekdayOfMonth?.value))) {
                parts.push('based on the last completion date');
            } else if (mode === 'day' && dayOfMonth?.value) {
                parts.push(`on day ${dayOfMonth.value}`);
            } else if (mode === 'weekday' && weekOfMonth?.value && weekdayOfMonth?.value) {
                parts.push(`on the ${weekOfMonth.selectedOptions[0]?.textContent.trim()} ${weekdayOfMonth.selectedOptions[0]?.textContent.trim()}`);
            }
        }
        const monthsSelected = Array.from(months?.selectedOptions || []).map(o => o.textContent.trim());
        if (monthsSelected.length) parts.push(`active in ${monthsSelected.join(', ')}`);
        parts.push('Next interval starts after completion.');
        return parts.join(' ');
    }

    // Listen for changes on fields that affect dynamic content
    [frequency, intervalValue, monthlyMode, dayOfMonth, weekOfMonth, weekdayOfMonth, daysOfWeek, months, pointsInput, difficultyInput]
        .forEach(el => el?.addEventListener('change', updateDynamic));
    [intervalValue, dayOfMonth, pointsInput].forEach(el => el?.addEventListener('input', updateDynamic));

    updateDynamic();
})();
</script>
{% endblock %}
