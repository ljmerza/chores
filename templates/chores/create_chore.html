{% extends 'base.html' %}

{% block title %}Create Chore{% endblock %}

{% block content %}
<div class="py-10">
    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        <div class="p-6 md:p-10">
            <div class="flex items-center justify-between flex-col md:flex-row gap-3 mb-6">
                <div>
                    <p class="text-sm uppercase text-primary tracking-widest font-semibold">Chore Builder</p>
                    <h1 class="text-3xl font-bold text-gray-900">
                        {% if edit_mode %}Edit chore{% else %}Create a new chore{% endif %}
                    </h1>
                    <p class="text-gray-600 mt-1">Admins/owners can create chores. Global chores can be claimed by anyone.</p>
                </div>
                <a href="{% url 'home' %}?household={{ selected_household.id }}"
                    class="text-primary font-semibold hover:underline">Back to dashboard</a>
            </div>

            {% if form.errors %}
            <div class="mb-4">
                {% include 'components/alert.html' with variant="error" message="Please fix the errors below." %}
            </div>
            {% endif %}

            <form method="post" class="space-y-8">
                {% csrf_token %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include 'components/form_field.html' with label="Title" field=form.title errors=form.title.errors required=True for_id=form.title.id_for_label %}
                    {% include 'components/form_field.html' with label="Household" field=form.household errors=form.household.errors required=True for_id=form.household.id_for_label %}
                </div>

                {% include 'components/form_field.html' with label="Description" field=form.description errors=form.description.errors for_id=form.description.id_for_label %}

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% include 'components/form_field.html' with label="Assignment Type" field=form.assignment_type errors=form.assignment_type.errors required=True for_id=form.assignment_type.id_for_label help_text="Assigned = choose user. Global = anyone can claim." %}
                    <div id="assignee-wrapper" data-disable-wrapper="assignee">
                        {% include 'components/form_field.html' with label="Assignee (for assigned)" field=form.assigned_to errors=form.assigned_to.errors for_id=form.assigned_to.id_for_label %}
                    </div>
                    <div id="rotation-wrapper" data-disable-wrapper="rotation">
                        {% include 'components/form_field.html' with label="Rotation users (for rotating)" field=form.rotation_users errors=form.rotation_users.errors for_id=form.rotation_users.id_for_label help_text="Defaults to everyone; pick who participates in the rotation." %}
                    </div>
                    {% include 'components/form_field.html' with label="Priority" field=form.priority errors=form.priority.errors for_id=form.priority.id_for_label %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% include 'components/form_field.html' with label="Points" field=form.base_points errors=form.base_points.errors required=True for_id=form.base_points.id_for_label %}
                    {% include 'components/form_field.html' with label="Difficulty" field=form.difficulty errors=form.difficulty.errors required=True for_id=form.difficulty.id_for_label %}
                    <div>
                        {% include 'components/form_field.html' with label="Due date (optional)" field=form.due_date errors=form.due_date.errors for_id=form.due_date.id_for_label %}
                        <label class="inline-flex items-center space-x-2 mt-2">
                            {{ form.anytime }}
                            <span class="text-sm text-gray-700">Anytime (no due date / no recurrence)</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-200 rounded-xl p-4" id="recurrence-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">Recurrence</h3>
                            <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                                <label class="inline-flex items-center space-x-2">
                                    {{ form.anytime }}
                                    <span class="text-sm text-gray-700">Anytime</span>
                                </label>
                                <label class="inline-flex items-center space-x-2">
                                    {{ form.is_recurring }}
                                    <span class="text-sm text-gray-700">Recurring?</span>
                                </label>
                            </div>
                        </div>

                        <p class="text-xs text-gray-600 mb-2">Recurring timers start after you complete the chore; overdue chores shift forward based on when you finish.</p>

                        <div class="space-y-3" id="recurrence-fields">
                            {% include 'components/form_field.html' with label="Frequency" field=form.frequency errors=form.frequency.errors for_id=form.frequency.id_for_label %}

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
                                {% include 'components/form_field.html' with label="Repeat every" field=form.interval_value errors=form.interval_value.errors for_id=form.interval_value.id_for_label %}
                                <div>
                                    <p class="text-sm text-gray-700 mb-1">Interval unit</p>
                                    <p id="interval-unit-label" class="text-sm font-semibold text-gray-900">weeks</p>
                                    <p class="text-xs text-gray-500">Changes with frequency (days/weeks/months).</p>
                                </div>
                            </div>

                            <div id="monthly-fields" class="space-y-2" data-disable-wrapper="monthly">
                                <p class="text-sm font-semibold text-gray-800">Monthly options</p>
                                <p class="text-xs text-gray-600">Select a day/weekday pattern or leave these blank to repeat monthly from the last completion date.</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {% include 'components/form_field.html' with label="Mode" label_hint="(day, weekday, or completion-based)" field=form.monthly_mode errors=form.monthly_mode.errors for_id=form.monthly_mode.id_for_label wrapper_classes="text-sm" %}
                                    <div id="monthly-day-wrapper" data-disable-wrapper="monthly-day">
                                        {% include 'components/form_field.html' with label="Day of month" field=form.day_of_month errors=form.day_of_month.errors for_id=form.day_of_month.id_for_label wrapper_classes="text-sm" %}
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="monthly-weekday-wrapper" data-disable-wrapper="monthly-weekday">
                                    {% include 'components/form_field.html' with label="Week of month" field=form.week_of_month errors=form.week_of_month.errors for_id=form.week_of_month.id_for_label wrapper_classes="text-sm" %}
                                    {% include 'components/form_field.html' with label="Weekday" field=form.weekday_of_month errors=form.weekday_of_month.errors for_id=form.weekday_of_month.id_for_label wrapper_classes="text-sm" %}
                                </div>
                            </div>

                            <div id="weekly-fields" data-disable-wrapper="weekly">
                                {% include 'components/form_field.html' with label="Active days of week (optional)" field=form.days_of_week errors=form.days_of_week.errors for_id=form.days_of_week.id_for_label help_text="Applies to any frequency; leave empty for all days." %}
                            </div>

                            {% include 'components/form_field.html' with label="Active months (optional)" field=form.months_of_year errors=form.months_of_year.errors for_id=form.months_of_year.id_for_label help_text="Limit to certain months (e.g., summer tasks)." %}

                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Summary</p>
                                <p id="recurrence-summary" class="text-sm text-gray-800">Repeats based on the settings above.</p>
                            </div>
                        </div>
                    </div>

                    <div class="border border-gray-200 rounded-xl p-4 space-y-3">
                        <h3 class="text-lg font-semibold text-gray-900">Verification</h3>
                        <label class="inline-flex items-center space-x-2">
                            {{ form.requires_verification }}
                            <span class="text-sm text-gray-800">Requires verification</span>
                        </label>
                        <label class="inline-flex items-center space-x-2">
                            {{ form.verification_photo_required }}
                            <span class="text-sm text-gray-800">Photo required</span>
                        </label>
                        <p class="text-xs text-gray-500">Admins/owners can approve completed chores when verification is on.</p>
                    </div>
                </div>

                <div class="flex justify-end gap-3 items-center flex-wrap">
                    {% url 'home' as home_url %}
                    {% if selected_household %}
                        {% with household_id=selected_household.id|stringformat:"s" %}
                            {% with cancel_href=home_url|add:"?household="|add:household_id %}
                                {% include 'components/button.html' with href=cancel_href label="Cancel" variant="secondary" size="md" %}
                            {% endwith %}
                        {% endwith %}
                    {% else %}
                        {% include 'components/button.html' with href=home_url label="Cancel" variant="secondary" size="md" %}
                    {% endif %}
                    {% include 'components/button.html' with type="submit" label=edit_mode|yesno:"Update chore,Create chore" variant="primary" size="lg" %}
                    <div class="flex items-center text-sm text-gray-500">
                        <span class="mr-2">Effort/points preview:</span>
                        <span id="points-preview" class="font-semibold text-gray-800">{{ form.base_points.value|default:form.base_points.initial|default:10 }} pts · {{ form.difficulty.value|default:form.difficulty.initial|default:"medium" }}</span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const isRecurring = document.getElementById("id_is_recurring");
        const frequency = document.getElementById("id_frequency");
        const weekly = document.getElementById("weekly-fields");
        const monthly = document.getElementById("monthly-fields");
        const months = document.getElementById("id_months_of_year");
        const daysOfWeek = document.getElementById("id_days_of_week");
        const dayOfMonth = document.getElementById("id_day_of_month");
        const weekOfMonth = document.getElementById("id_week_of_month");
        const weekdayOfMonth = document.getElementById("id_weekday_of_month");
        const monthlyMode = document.getElementById("id_monthly_mode");
        const intervalValue = document.getElementById("id_interval_value");
        const intervalUnitLabel = document.getElementById("interval-unit-label");
        const assignmentType = document.getElementById("id_assignment_type");
        const assignee = document.getElementById("id_assigned_to");
        const assigneeWrapper = document.getElementById("assignee-wrapper");
        const rotationWrapper = document.getElementById("rotation-wrapper");
        const rotationUsers = document.getElementById("id_rotation_users");
        const summaryEl = document.getElementById("recurrence-summary");
        const pointsInput = document.getElementById("id_base_points");
        const difficultyInput = document.getElementById("id_difficulty");
        const pointsPreview = document.getElementById("points-preview");
        const anytime = document.getElementById("id_anytime");
        const dueDate = document.getElementById("id_due_date");
        const recurrenceFields = document.getElementById("recurrence-fields");

        function setDisabled(el, disabled) {
            if (!el) return;
            if (el.tagName === 'SELECT' && el.multiple) {
                [...el.options].forEach(opt => opt.disabled = disabled);
            }
            el.disabled = disabled;
            const wrapper = el.closest('[data-disable-wrapper]') || el.parentElement;
            if (!wrapper) return;
            wrapper.classList.toggle('opacity-50', disabled);
        }

        function describeRecurrence() {
            if (anytime?.checked) return "Anytime chore (no due date / recurrence).";
            if (!isRecurring?.checked) return "One-time chore (no recurrence).";

            const freq = frequency?.value || 'weekly';
            const interval = intervalValue?.value || '1';
            const days = Array.from(daysOfWeek?.selectedOptions || []).map(o => o.textContent.trim());
            const monthsSelected = Array.from(months?.selectedOptions || []).map(o => o.textContent.trim());
            const mode = monthlyMode?.value || 'day';
            const hasDayOfMonth = !!dayOfMonth?.value;
            const hasWeekPattern = !!(weekOfMonth?.value && weekdayOfMonth?.value);

            let parts = [`Every ${interval} ${freq === 'daily' ? 'day' : freq === 'weekly' ? 'week' : 'month'}`];
            if (parseInt(interval, 10) > 1) {
                parts[0] += 's';
            }

            if (days.length) {
                parts.push(`on ${days.join(', ')}`);
            }

            if (freq === 'monthly') {
                if (mode === 'from_completion' || (!hasDayOfMonth && !hasWeekPattern)) {
                    parts.push('based on the last completion date');
                } else if (mode === 'day' && hasDayOfMonth) {
                    parts.push(`on day ${dayOfMonth.value}`);
                } else if (mode !== 'day' && hasWeekPattern) {
                    const womText = weekOfMonth.selectedOptions[0]?.textContent.trim();
                    const womDayText = weekdayOfMonth.selectedOptions[0]?.textContent.trim();
                    parts.push(`on the ${womText} ${womDayText}`);
                }
            }

            if (monthsSelected.length) {
                parts.push(`active in ${monthsSelected.join(', ')}`);
            }

            parts.push('Next interval starts after completion (overdue chores shift forward).');

            return parts.join(' ');
        }

        function updateVisibility(source) {
            let isAnytimeChecked = anytime?.checked;
            let isRecurringChecked = isRecurring?.checked;

            if (source === 'anytime' && isAnytimeChecked && isRecurring) {
                isRecurring.checked = false;
                isRecurringChecked = false;
            }
            if (source === 'recurring' && isRecurringChecked && anytime) {
                anytime.checked = false;
                isAnytimeChecked = false;
            }
            if (anytime?.checked && isRecurring?.checked) {
                isRecurring.checked = false;
                isRecurringChecked = false;
            }

            const recurringOn = isRecurringChecked && !isAnytimeChecked;
            const assignVal = assignmentType?.value;
            const freq = frequency?.value;
            const mode = monthlyMode?.value || 'day';
            const useDay = mode === 'day';
            const useWeekPattern = mode === 'weekday';

            const unitText = freq === 'daily' ? 'days' : freq === 'weekly' ? 'weeks' : 'months';
            if (intervalUnitLabel) intervalUnitLabel.textContent = unitText;

            if (isAnytimeChecked) {
                if (dueDate) {
                    dueDate.value = '';
                    setDisabled(dueDate, true);
                }
            } else {
                setDisabled(dueDate, false);
            }

            setDisabled(frequency, !recurringOn);

            if (!recurringOn) {
                weekly.style.display = 'none';
                monthly.style.display = 'none';
                setDisabled(daysOfWeek, true);
                setDisabled(dayOfMonth, true);
                setDisabled(weekOfMonth, true);
                setDisabled(weekdayOfMonth, true);
                setDisabled(monthlyMode, true);
                setDisabled(intervalValue, true);
                setDisabled(months, true);
                recurrenceFields?.classList.add('opacity-50');
                recurrenceFields?.classList.add('pointer-events-none');
            } else {
                weekly.style.display = '';
                monthly.style.display = freq === 'monthly' ? '' : 'none';

                setDisabled(intervalValue, false);
                setDisabled(months, false);
                setDisabled(monthlyMode, freq !== 'monthly');
                setDisabled(daysOfWeek, false);
                recurrenceFields?.classList.remove('opacity-50');
                recurrenceFields?.classList.remove('pointer-events-none');

                const useCompletion = mode === 'from_completion';
                setDisabled(dayOfMonth, !(freq === 'monthly' && useDay));
                setDisabled(weekOfMonth, !(freq === 'monthly' && useWeekPattern));
                setDisabled(weekdayOfMonth, !(freq === 'monthly' && useWeekPattern));

                const monthDayWrapper = document.getElementById('monthly-day-wrapper');
                const monthWeekWrapper = document.getElementById('monthly-weekday-wrapper');
                if (monthDayWrapper) monthDayWrapper.style.display = freq === 'monthly' && useDay ? '' : 'none';
                if (monthWeekWrapper) monthWeekWrapper.style.display = freq === 'monthly' && useWeekPattern ? '' : 'none';
                if (monthDayWrapper && useCompletion) monthDayWrapper.style.display = 'none';
                if (monthWeekWrapper && useCompletion) monthWeekWrapper.style.display = 'none';
            }

            const assigned = assignVal === 'assigned';
            assigneeWrapper.style.opacity = assigned ? '1' : '0.5';
            setDisabled(assignee, !assigned);

            const rotating = assignVal === 'rotating';
            rotationWrapper?.classList.toggle('opacity-50', !rotating);
            setDisabled(rotationUsers, !rotating);

            if (summaryEl) {
                summaryEl.textContent = describeRecurrence();
            }

            if (pointsPreview) {
                const pts = pointsInput?.value || '';
                const diff = difficultyInput?.selectedOptions?.[0]?.textContent.trim() || difficultyInput?.value || 'Medium';
                pointsPreview.textContent = `${pts || '—'} pts · ${diff}`;
            }
        }

        isRecurring?.addEventListener('change', () => updateVisibility('recurring'));
        frequency?.addEventListener('change', updateVisibility);
        monthlyMode?.addEventListener('change', updateVisibility);
        assignmentType?.addEventListener('change', updateVisibility);
        pointsInput?.addEventListener('input', updateVisibility);
        difficultyInput?.addEventListener('change', updateVisibility);
        rotationUsers?.addEventListener('change', updateVisibility);
        anytime?.addEventListener('change', () => updateVisibility('anytime'));
        months?.addEventListener('change', updateVisibility);
        daysOfWeek?.addEventListener('change', updateVisibility);
        dayOfMonth?.addEventListener('input', updateVisibility);
        weekOfMonth?.addEventListener('change', updateVisibility);
        weekdayOfMonth?.addEventListener('change', updateVisibility);
        intervalValue?.addEventListener('input', updateVisibility);
        document.addEventListener('DOMContentLoaded', updateVisibility);
        updateVisibility();
    })();
</script>
{% endblock %}
