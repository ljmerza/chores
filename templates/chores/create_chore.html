{% extends 'base.html' %}

{% block title %}Create Chore{% endblock %}

{% block content %}
<div class="py-10">
    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        <div class="p-6 md:p-10">
            <div class="flex items-center justify-between flex-col md:flex-row gap-3 mb-6">
                <div>
                    <p class="text-sm uppercase text-primary tracking-widest font-semibold">Chore Builder</p>
                    <h1 class="text-3xl font-bold text-gray-900">
                        {% if edit_mode %}Edit chore{% else %}Create a new chore{% endif %}
                    </h1>
                    <p class="text-gray-600 mt-1">Admins/owners can create chores. Global chores can be claimed by anyone.</p>
                </div>
                <a href="{% url 'home' %}?household={{ selected_household.id }}"
                    class="text-primary font-semibold hover:underline">Back to dashboard</a>
            </div>

            {% if form.errors %}
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
                Please fix the errors below.
            </div>
            {% endif %}

            <form method="post" class="space-y-8">
                {% csrf_token %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-800 mb-1">
                            Title <span class="text-red-600 text-xs font-normal">required</span>
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <p class="text-xs text-red-500 mt-1">{{ form.title.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-800 mb-1">
                            Household <span class="text-red-600 text-xs font-normal">required</span>
                        </label>
                        {{ form.household }}
                        {% if form.household.errors %}
                        <p class="text-xs text-red-500 mt-1">{{ form.household.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-800 mb-1">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <p class="text-xs text-red-500 mt-1">{{ form.description.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-800 mb-1">
                            Assignment Type <span class="text-red-600 text-xs font-normal">required</span>
                        </label>
                        {{ form.assignment_type }}
                        {% if form.assignment_type.errors %}
                        <p class="text-xs text-red-500 mt-1">{{ form.assignment_type.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Assigned = choose user. Global = anyone can claim.</p>
                    </div>
                    <div id="assignee-wrapper" data-disable-wrapper="assignee">
                        <label class="block text-sm font-semibold text-gray-800 mb-1">Assignee (for assigned)</label>
                        {{ form.assigned_to }}
                        {% if form.assigned_to.errors %}
                        <p class="text-xs text-red-500 mt-1">{{ form.assigned_to.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div id="rotation-wrapper" data-disable-wrapper="rotation">
                        <label class="block text-sm font-semibold text-gray-800 mb-1">Rotation users (for rotating)</label>
                        {{ form.rotation_users }}
                        {% if form.rotation_users.errors %}
                        <p class="text-xs text-red-500 mt-1">{{ form.rotation_users.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Defaults to everyone; pick who participates in the rotation.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-800 mb-1">Priority</label>
                        {{ form.priority }}
                        {% if form.priority.errors %}
                        <p class="text-xs text-red-500 mt-1">{{ form.priority.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-800 mb-1">
                            Points <span class="text-red-600 text-xs font-normal">required</span>
                        </label>
                        {{ form.base_points }}
                        {% if form.base_points.errors %}
                        <p class="text-xs text-red-500 mt-1">{{ form.base_points.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-800 mb-1">
                            Difficulty <span class="text-red-600 text-xs font-normal">required</span>
                        </label>
                        {{ form.difficulty }}
                        {% if form.difficulty.errors %}
                        <p class="text-xs text-red-500 mt-1">{{ form.difficulty.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-800 mb-1">Due date (optional)</label>
                        {{ form.due_date }}
                        {% if form.due_date.errors %}
                        <p class="text-xs text-red-500 mt-1">{{ form.due_date.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-200 rounded-xl p-4" id="recurrence-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">Recurrence</h3>
                            <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                                <label class="inline-flex items-center space-x-2">
                                    {{ form.anytime }}
                                    <span class="text-sm text-gray-700">Anytime</span>
                                </label>
                                <label class="inline-flex items-center space-x-2">
                                    {{ form.is_recurring }}
                                    <span class="text-sm text-gray-700">Recurring?</span>
                                </label>
                            </div>
                        </div>

                        <div class="space-y-3" id="recurrence-fields">
                            <div>
                                <label class="block text-sm font-semibold text-gray-800 mb-1">Frequency</label>
                                {{ form.frequency }}
                                {% if form.frequency.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.frequency.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-1">Repeat every</label>
                                    {{ form.interval_value }}
                                    {% if form.interval_value.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.interval_value.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                <div>
                                    <p class="text-sm text-gray-700 mb-1">Interval unit</p>
                                    <p id="interval-unit-label" class="text-sm font-semibold text-gray-900">weeks</p>
                                    <p class="text-xs text-gray-500">Changes with frequency (days/weeks/months).</p>
                                </div>
                            </div>

                            <div id="monthly-fields" class="space-y-2" data-disable-wrapper="monthly">
                                <label class="block text-sm font-semibold text-gray-800 mb-1">Monthly options</label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-700 mb-1">Mode</label>
                                        {{ form.monthly_mode }}
                                        {% if form.monthly_mode.errors %}
                                        <p class="text-xs text-red-500 mt-1">{{ form.monthly_mode.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    <div id="monthly-day-wrapper" data-disable-wrapper="monthly-day">
                                        <label class="block text-xs text-gray-700 mb-1">Day of month</label>
                                        {{ form.day_of_month }}
                                        {% if form.day_of_month.errors %}
                                        <p class="text-xs text-red-500 mt-1">{{ form.day_of_month.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="monthly-weekday-wrapper" data-disable-wrapper="monthly-weekday">
                                    <div>
                                        <label class="block text-xs text-gray-700 mb-1">Week of month</label>
                                        {{ form.week_of_month }}
                                        {% if form.week_of_month.errors %}
                                        <p class="text-xs text-red-500 mt-1">{{ form.week_of_month.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-700 mb-1">Weekday</label>
                                        {{ form.weekday_of_month }}
                                        {% if form.weekday_of_month.errors %}
                                        <p class="text-xs text-red-500 mt-1">{{ form.weekday_of_month.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div id="weekly-fields" data-disable-wrapper="weekly">
                                <label class="block text-sm font-semibold text-gray-800 mb-1">Active days of week
                                    (optional)</label>
                                {{ form.days_of_week }}
                                {% if form.days_of_week.errors %}
                                <p class="text-xs text-red-500 mt-1">{{ form.days_of_week.errors.0 }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Applies to any frequency; leave empty for all
                                    days.</p>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-800 mb-1">Active months
                                    (optional)</label>
                                {{ form.months_of_year }}
                                {% if form.months_of_year.errors %}
                                <p class="text-xs text-red-500 mt-1">{{ form.months_of_year.errors.0 }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Limit to certain months (e.g., summer tasks).</p>
                            </div>

                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Summary</p>
                                <p id="recurrence-summary" class="text-sm text-gray-800">Repeats based on the settings above.</p>
                            </div>
                        </div>
                    </div>

                    <div class="border border-gray-200 rounded-xl p-4 space-y-3">
                        <h3 class="text-lg font-semibold text-gray-900">Verification</h3>
                        <label class="inline-flex items-center space-x-2">
                            {{ form.requires_verification }}
                            <span class="text-sm text-gray-800">Requires verification</span>
                        </label>
                        <label class="inline-flex items-center space-x-2">
                            {{ form.verification_photo_required }}
                            <span class="text-sm text-gray-800">Photo required</span>
                        </label>
                        <p class="text-xs text-gray-500">Admins/owners can approve completed chores when verification is on.</p>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <a href="{% url 'home' %}?household={{ selected_household.id }}"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">Cancel</a>
                    <button type="submit"
                        class="px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition">
                        {% if edit_mode %}Update chore{% else %}Create chore{% endif %}
                    </button>
                    <div class="flex items-center text-sm text-gray-500">
                        <span class="mr-2">Effort/points preview:</span>
                        <span id="points-preview" class="font-semibold text-gray-800">{{ form.base_points.value|default:form.base_points.initial|default:10 }} pts · {{ form.difficulty.value|default:form.difficulty.initial|default:"medium" }}</span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const isRecurring = document.getElementById("id_is_recurring");
        const frequency = document.getElementById("id_frequency");
        const weekly = document.getElementById("weekly-fields");
        const monthly = document.getElementById("monthly-fields");
        const months = document.getElementById("id_months_of_year");
        const daysOfWeek = document.getElementById("id_days_of_week");
        const dayOfMonth = document.getElementById("id_day_of_month");
        const weekOfMonth = document.getElementById("id_week_of_month");
        const weekdayOfMonth = document.getElementById("id_weekday_of_month");
        const monthlyMode = document.getElementById("id_monthly_mode");
        const intervalValue = document.getElementById("id_interval_value");
        const intervalUnitLabel = document.getElementById("interval-unit-label");
        const assignmentType = document.getElementById("id_assignment_type");
        const assignee = document.getElementById("id_assigned_to");
        const assigneeWrapper = document.getElementById("assignee-wrapper");
        const rotationWrapper = document.getElementById("rotation-wrapper");
        const rotationUsers = document.getElementById("id_rotation_users");
        const summaryEl = document.getElementById("recurrence-summary");
        const pointsInput = document.getElementById("id_base_points");
        const difficultyInput = document.getElementById("id_difficulty");
        const pointsPreview = document.getElementById("points-preview");
        const anytime = document.getElementById("id_anytime");
        const dueDate = document.getElementById("id_due_date");
        const recurrenceFields = document.getElementById("recurrence-fields");

        function setDisabled(el, disabled) {
            if (!el) return;
            if (el.tagName === 'SELECT' && el.multiple) {
                [...el.options].forEach(opt => opt.disabled = disabled);
            }
            el.disabled = disabled;
            const wrapper = el.closest('[data-disable-wrapper]') || el.parentElement;
            if (!wrapper) return;
            wrapper.classList.toggle('opacity-50', disabled);
        }

        function describeRecurrence() {
            if (anytime?.checked) return "Anytime chore (no due date / recurrence).";
            if (!isRecurring?.checked) return "One-time chore (no recurrence).";

            const freq = frequency?.value || 'weekly';
            const interval = intervalValue?.value || '1';
            const days = Array.from(daysOfWeek?.selectedOptions || []).map(o => o.textContent.trim());
            const monthsSelected = Array.from(months?.selectedOptions || []).map(o => o.textContent.trim());
            const mode = monthlyMode?.value || 'day';

            let parts = [`Every ${interval} ${freq === 'daily' ? 'day' : freq === 'weekly' ? 'week' : 'month'}`];
            if (parseInt(interval, 10) > 1) {
                parts[0] += 's';
            }

            if (days.length) {
                parts.push(`on ${days.join(', ')}`);
            }

            if (freq === 'monthly') {
                if (mode === 'day' && dayOfMonth?.value) {
                    parts.push(`on day ${dayOfMonth.value}`);
                }
                if (mode !== 'day' && weekOfMonth?.value && weekdayOfMonth?.value) {
                    const womText = weekOfMonth.selectedOptions[0]?.textContent.trim();
                    const womDayText = weekdayOfMonth.selectedOptions[0]?.textContent.trim();
                    parts.push(`on the ${womText} ${womDayText}`);
                }
            }

            if (monthsSelected.length) {
                parts.push(`active in ${monthsSelected.join(', ')}`);
            }

            return parts.join(' ');
        }

        function updateVisibility(source) {
            let isAnytimeChecked = anytime?.checked;
            let isRecurringChecked = isRecurring?.checked;

            if (source === 'anytime' && isAnytimeChecked && isRecurring) {
                isRecurring.checked = false;
                isRecurringChecked = false;
            }
            if (source === 'recurring' && isRecurringChecked && anytime) {
                anytime.checked = false;
                isAnytimeChecked = false;
            }
            if (anytime?.checked && isRecurring?.checked) {
                isRecurring.checked = false;
                isRecurringChecked = false;
            }

            const recurringOn = isRecurringChecked && !isAnytimeChecked;
            const assignVal = assignmentType?.value;
            const freq = frequency?.value;
            const mode = monthlyMode?.value || 'day';

            const unitText = freq === 'daily' ? 'days' : freq === 'weekly' ? 'weeks' : 'months';
            if (intervalUnitLabel) intervalUnitLabel.textContent = unitText;

            if (isAnytimeChecked) {
                if (dueDate) {
                    dueDate.value = '';
                    setDisabled(dueDate, true);
                }
            } else {
                setDisabled(dueDate, false);
            }

            setDisabled(frequency, !recurringOn);

            if (!recurringOn) {
                weekly.style.display = 'none';
                monthly.style.display = 'none';
                setDisabled(daysOfWeek, true);
                setDisabled(dayOfMonth, true);
                setDisabled(weekOfMonth, true);
                setDisabled(weekdayOfMonth, true);
                setDisabled(monthlyMode, true);
                setDisabled(intervalValue, true);
                setDisabled(months, true);
                recurrenceFields?.classList.add('opacity-50');
                recurrenceFields?.classList.add('pointer-events-none');
            } else {
                weekly.style.display = '';
                monthly.style.display = freq === 'monthly' ? '' : 'none';

                setDisabled(intervalValue, false);
                setDisabled(months, false);
                setDisabled(monthlyMode, freq !== 'monthly');
                setDisabled(daysOfWeek, false);
                recurrenceFields?.classList.remove('opacity-50');
                recurrenceFields?.classList.remove('pointer-events-none');

                const useDay = mode === 'day';
                setDisabled(dayOfMonth, !(freq === 'monthly' && useDay));
                setDisabled(weekOfMonth, !(freq === 'monthly' && !useDay));
                setDisabled(weekdayOfMonth, !(freq === 'monthly' && !useDay));

                const monthDayWrapper = document.getElementById('monthly-day-wrapper');
                const monthWeekWrapper = document.getElementById('monthly-weekday-wrapper');
                if (monthDayWrapper) monthDayWrapper.style.display = useDay ? '' : 'none';
                if (monthWeekWrapper) monthWeekWrapper.style.display = useDay ? 'none' : '';
            }

            const assigned = assignVal === 'assigned';
            assigneeWrapper.style.opacity = assigned ? '1' : '0.5';
            setDisabled(assignee, !assigned);

            const rotating = assignVal === 'rotating';
            rotationWrapper?.classList.toggle('opacity-50', !rotating);
            setDisabled(rotationUsers, !rotating);

            if (summaryEl) {
                summaryEl.textContent = describeRecurrence();
            }

            if (pointsPreview) {
                const pts = pointsInput?.value || '';
                const diff = difficultyInput?.selectedOptions?.[0]?.textContent.trim() || difficultyInput?.value || 'Medium';
                pointsPreview.textContent = `${pts || '—'} pts · ${diff}`;
            }
        }

        isRecurring?.addEventListener('change', () => updateVisibility('recurring'));
        frequency?.addEventListener('change', updateVisibility);
        monthlyMode?.addEventListener('change', updateVisibility);
        assignmentType?.addEventListener('change', updateVisibility);
        pointsInput?.addEventListener('input', updateVisibility);
        difficultyInput?.addEventListener('change', updateVisibility);
        rotationUsers?.addEventListener('change', updateVisibility);
        anytime?.addEventListener('change', () => updateVisibility('anytime'));
        months?.addEventListener('change', updateVisibility);
        daysOfWeek?.addEventListener('change', updateVisibility);
        dayOfMonth?.addEventListener('input', updateVisibility);
        weekOfMonth?.addEventListener('change', updateVisibility);
        weekdayOfMonth?.addEventListener('change', updateVisibility);
        intervalValue?.addEventListener('input', updateVisibility);
        document.addEventListener('DOMContentLoaded', updateVisibility);
        updateVisibility();
    })();
</script>
{% endblock %}
